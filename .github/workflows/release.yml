name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt nuitka zstandard

    - name: Handle existing Tag and Release
      shell: pwsh
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        $ErrorActionPreference = 'Continue'
        $version = "${{ github.event.inputs.version }}"
        
        # Check if release exists and delete it
        $releaseExists = gh release view $version 2>&1
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Deleting existing release $version..."
          gh release delete $version --yes --cleanup-tag
        } else {
          Write-Host "No existing release found for $version"
        }
        
        # Check if tag exists and delete it
        $tagExists = git ls-remote --tags origin "refs/tags/$version"
        if ($tagExists) {
          Write-Host "Deleting existing tag $version..."
          git push --delete origin $version 2>&1 | Out-Null
        }
        
        exit 0

    - name: Pre-process Code (Remove Comments)
      run: |
        python remove.py

    - name: Build with Nuitka
      run: |
        python -m nuitka --onefile --standalone --windows-disable-console --enable-plugin=pyside6 --include-data-dir=scripts=scripts --include-data-file=logo.png=logo.png --output-dir=build toolbox.py

    - name: Rename executable
      shell: pwsh
      run: |
        $version = "${{ github.event.inputs.version }}"
        Move-Item -Path "build/toolbox.exe" -Destination "build/WindowsTools-$version.exe" -Force

    - name: Get Changelog
      id: changelog
      shell: pwsh
      run: |
        $version = "${{ github.event.inputs.version }}"
        $changelogFile = "docs/Changelog/$version.md"
        if (Test-Path $changelogFile) {
          $content = Get-Content $changelogFile -Raw
          "CHANGELOG_CONTENT<<EOF" | Out-File -FilePath $env:GITHUB_ENV -Append
          $content | Out-File -FilePath $env:GITHUB_ENV -Append
          "EOF" | Out-File -FilePath $env:GITHUB_ENV -Append
        } else {
          "CHANGELOG_CONTENT=Release $version" | Out-File -FilePath $env:GITHUB_ENV -Append
        }

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: ${{ github.event.inputs.version }}
        body: ${{ env.CHANGELOG_CONTENT }}
        files: build/WindowsTools-${{ github.event.inputs.version }}.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
